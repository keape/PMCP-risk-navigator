<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PMCP – Portfolio Plateau</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", -apple-system, system-ui, sans-serif;
      background: #0b1220;
      color: #e2e8f0;
    }

    body {
      margin: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    main {
      width: min(1100px, 96vw);
      padding: 40px 0 80px;
      display: flex;
      flex-direction: column;
      gap: 36px;
    }

    header h1 {
      margin: 0;
      font-size: 2.15rem;
      letter-spacing: 0.02em;
    }

    header .meta {
      margin-top: 6px;
      font-size: 0.95rem;
      color: #94a3b8;
    }

    section {
      background: rgba(12, 20, 35, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 18px;
      padding: 26px;
      box-shadow: 0 24px 50px rgba(8, 13, 23, 0.45);
    }

    section h2 {
      margin: 0 0 18px;
      font-size: 1.35rem;
    }

    p { line-height: 1.6; }

    .intro-note {
      margin-top: 14px;
      font-size: 0.95rem;
      color: #cbd5f5;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(10, 17, 30, 0.65);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 680px;
    }

    thead {
      background: rgba(30, 41, 59, 0.95);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.85rem;
    }

    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      text-align: left;
    }

    tbody tr.closed td { opacity: 0.65; }
    tbody tr:nth-child(odd) { background: rgba(13, 22, 40, 0.45); }

    input[type="number"], select {
      width: 100%;
      padding: 8px 10px;
      font-size: 0.93rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      background: rgba(15, 23, 42, 0.65);
      color: inherit;
      box-sizing: border-box;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .table-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.45);
      background: rgba(37, 99, 235, 0.24);
      color: #e0f2fe;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.4);
      color: #cbd5f5;
    }

    button.danger {
      border-color: rgba(248, 113, 113, 0.55);
      background: rgba(248, 113, 113, 0.22);
      color: #fecaca;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 18px;
    }

    .summary-card {
      padding: 18px;
      border-radius: 14px;
      background: rgba(20, 31, 53, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .summary-card .label {
      font-size: 0.85rem;
      letter-spacing: 0.02em;
      color: #94a3b8;
    }

    .summary-card .value {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .value.positive { color: #4ade80; }
    .value.negative { color: #f87171; }

    .meaning {
      margin-top: 22px;
      padding: 18px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.15);
      font-size: 0.92rem;
    }

    .meaning strong { color: #a5b4fc; }

    .file-tools {
      margin-top: 20px;
      display: grid;
      gap: 12px;
      font-size: 0.9rem;
    }

    .file-tools label {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-line {
      min-height: 1.2em;
      color: #a5b4fc;
    }

    .status-line.error { color: #fca5a5; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>PMCP – Portfolio Plateau (multi-long &amp; multi-short)</h1>
      <div class="meta" id="generatedMeta"></div>
      <p class="intro-note">
        Fill the tables. Use 1 in "Active" if the option is open, 0 if closed. "Realized_P/L" holds closed P/L. Le
        formule sottostanti replicano il Foglio4 del workbook originale.
      </p>
    </header>

    <section>
      <h2>Long puts (LEAP) — Active &amp; Realized</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th scope="col">Strike_KL</th>
              <th scope="col">Premium_Paid (tot)</th>
              <th scope="col">Qty</th>
              <th scope="col">Active (1/0)</th>
              <th scope="col">Realized_P/L</th>
              <th scope="col" style="width:70px;">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="longBody"></tbody>
        </table>
      </div>
      <div class="table-actions">
        <button id="addLongRow">Aggiungi riga long</button>
        <button id="resetLong" class="secondary">Ripristina esempio long</button>
      </div>
    </section>

    <section>
      <h2>Short puts (settimanali) — Active &amp; Realized</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th scope="col">Strike_KS</th>
              <th scope="col">Premium_Recv (tot)</th>
              <th scope="col">Qty</th>
              <th scope="col">Active (1/0)</th>
              <th scope="col">Realized_P/L</th>
              <th scope="col" style="width:70px;">&nbsp;</th>
            </tr>
          </thead>
          <tbody id="shortBody"></tbody>
        </table>
      </div>
      <div class="table-actions">
        <button id="addShortRow">Aggiungi riga short</button>
        <button id="resetShort" class="secondary">Ripristina esempio short</button>
      </div>
    </section>

    <section>
      <h2>Summary</h2>
      <div class="summary-grid">
        <div class="summary-card">
          <span class="label">Long (active) — S=0 payoff net</span>
          <span id="summaryLong" class="value">€0</span>
        </div>
        <div class="summary-card">
          <span class="label">Short (active) — S=0 payoff net</span>
          <span id="summaryShort" class="value">€0</span>
        </div>
        <div class="summary-card">
          <span class="label">Realized cashflow (closed)</span>
          <span id="summaryRealized" class="value">€0</span>
        </div>
        <div class="summary-card">
          <span class="label">Portfolio Plateau_min (worst-case)</span>
          <span id="summaryPlateau" class="value">€0</span>
        </div>
      </div>
      <div class="meaning">
        <p><strong>Meaning:</strong></p>
        <p>O5 = Value of active long puts at S=0 minus their cost.</p>
        <p>O6 = Premiums of active shorts minus obligation (strike*100).</p>
        <p>O7 = Sum of all closed/realized P/L (longs + shorts).</p>
        <p>O8 = Portfolio plateau_min (max loss/profit if S=0 now).</p>
      </div>
    </section>

    <section>
      <h2>Esporta / importa dati</h2>
      <div class="file-tools">
        <div>
          <button id="exportJson">Esporta in JSON</button>
          <button id="copyJson" class="secondary">Copia JSON negli appunti</button>
        </div>
        <label>
          <span>Importa da file JSON</span>
          <input id="importJson" type="file" accept="application/json" />
        </label>
        <div class="status-line" id="statusLine"></div>
      </div>
    </section>
  </main>

  <script>
    const longBody = document.getElementById('longBody');
    const shortBody = document.getElementById('shortBody');
    const summaryLong = document.getElementById('summaryLong');
    const summaryShort = document.getElementById('summaryShort');
    const summaryRealized = document.getElementById('summaryRealized');
    const summaryPlateau = document.getElementById('summaryPlateau');
    const statusLine = document.getElementById('statusLine');
    const generatedMeta = document.getElementById('generatedMeta');

    const CONTRACT_MULTIPLIER = 100;

    const dateFormatter = new Intl.DateTimeFormat('it-IT', {
      year: 'numeric', month: '2-digit', day: '2-digit'
    });

    function updateGeneratedMeta(date = new Date()) {
      generatedMeta.textContent = `Generated: ${dateFormatter.format(date)}`;
    }

    updateGeneratedMeta();

    function euro(amount) {
      const value = Number(amount) || 0;
      return value.toLocaleString('it-IT', {
        style: 'currency',
        currency: 'EUR',
        maximumFractionDigits: 0
      });
    }

    function setSummaryValue(el, amount) {
      const value = Number(amount) || 0;
      el.textContent = euro(value);
      el.classList.remove('positive', 'negative');
      if (value > 0) el.classList.add('positive');
      if (value < 0) el.classList.add('negative');
    }

    function cloneRowTemplate() {
      return { strike: null, premium: null, qty: 1, active: 1, realized: null };
    }

    const defaultLongRows = () => ([
      { strike: 550, premium: 3080, qty: 1, active: 1, realized: null },
      { strike: 590, premium: 3980, qty: 1, active: 1, realized: null }
    ]);

    const defaultShortRows = () => ([
      { strike: 550, premium: 400, qty: 1, active: 0, realized: 400 },
      { strike: 560, premium: 400, qty: 1, active: 0, realized: 400 },
      { strike: 570, premium: 400, qty: 1, active: 0, realized: 400 },
      { strike: 580, premium: 400, qty: 1, active: 0, realized: 400 },
      { strike: 590, premium: 400, qty: 1, active: 1, realized: 400 },
      { strike: 600, premium: 400, qty: 1, active: 1, realized: null }
    ]);

    const state = {
      longRows: defaultLongRows(),
      shortRows: defaultShortRows()
    };

    function parseNumber(value) {
      if (value === '' || value === null || value === undefined) return null;
      const numeric = Number(value);
      return Number.isFinite(numeric) ? numeric : null;
    }

    function ensureActive(value) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return 0;
      return numeric > 0 ? 1 : 0;
    }

    function renderTable(body, rows, type) {
      body.innerHTML = '';
      rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        if (ensureActive(row.active) === 0) tr.classList.add('closed');

        function buildNumberCell(key, step = '1', min = null) {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.step = step;
          if (min !== null) input.min = String(min);
          input.value = row[key] ?? '';
          input.addEventListener('input', () => {
            const value = parseNumber(input.value);
            row[key] = value;
            updateSummary();
          });
          td.appendChild(input);
          return td;
        }

        const strikeCell = buildNumberCell('strike', '0.01', 0);
        const premiumCell = buildNumberCell('premium', '0.01', 0);
        const qtyCell = buildNumberCell('qty', '1', 0);
        const activeCell = document.createElement('td');
        const activeInput = document.createElement('input');
        activeInput.type = 'number';
        activeInput.min = '0';
        activeInput.max = '1';
        activeInput.step = '1';
        activeInput.value = row.active ?? 1;
        activeInput.addEventListener('input', () => {
          row.active = ensureActive(activeInput.value);
          renderTable(body, rows, type);
          updateSummary();
        });
        activeCell.appendChild(activeInput);

        const realizedCell = buildNumberCell('realized', '0.01');

        const actionCell = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'danger';
        removeBtn.textContent = 'Elimina';
        removeBtn.addEventListener('click', () => {
          rows.splice(index, 1);
          renderTables();
          updateSummary();
        });
        actionCell.appendChild(removeBtn);

        tr.appendChild(strikeCell);
        tr.appendChild(premiumCell);
        tr.appendChild(qtyCell);
        tr.appendChild(activeCell);
        tr.appendChild(realizedCell);
        tr.appendChild(actionCell);
        body.appendChild(tr);
      });
    }

    function renderTables() {
      renderTable(longBody, state.longRows, 'long');
      renderTable(shortBody, state.shortRows, 'short');
    }

    function sumActiveLong() {
      return state.longRows.reduce((sum, row) => {
        if (ensureActive(row.active) === 1 && row.strike != null && row.premium != null && row.qty != null) {
          return sum + ((row.strike * CONTRACT_MULTIPLIER - row.premium) * row.qty);
        }
        return sum;
      }, 0);
    }

    function sumActiveShort() {
      return state.shortRows.reduce((sum, row) => {
        if (ensureActive(row.active) === 1 && row.strike != null && row.premium != null && row.qty != null) {
          return sum + ((row.premium - row.strike * CONTRACT_MULTIPLIER) * row.qty);
        }
        return sum;
      }, 0);
    }

    function sumRealized() {
      const realizedLong = state.longRows.reduce((sum, row) => {
        if (ensureActive(row.active) === 0 && row.realized != null) {
          return sum + row.realized;
        }
        return sum;
      }, 0);

      const realizedShort = state.shortRows.reduce((sum, row) => {
        if (ensureActive(row.active) === 0 && row.realized != null) {
          return sum + row.realized;
        }
        return sum;
      }, 0);

      return realizedLong + realizedShort;
    }

    function updateSummary() {
      const longActive = sumActiveLong();
      const shortActive = sumActiveShort();
      const realized = sumRealized();
      const plateau = longActive + shortActive + realized;

      setSummaryValue(summaryLong, longActive);
      setSummaryValue(summaryShort, shortActive);
      setSummaryValue(summaryRealized, realized);
      setSummaryValue(summaryPlateau, plateau);
    }

    document.getElementById('addLongRow').addEventListener('click', () => {
      state.longRows.push(cloneRowTemplate());
      renderTables();
      updateSummary();
    });

    document.getElementById('addShortRow').addEventListener('click', () => {
      state.shortRows.push(cloneRowTemplate());
      renderTables();
      updateSummary();
    });

    document.getElementById('resetLong').addEventListener('click', () => {
      state.longRows = defaultLongRows();
      renderTables();
      updateSummary();
      setStatus('Ripristinato esempio long.');
    });

    document.getElementById('resetShort').addEventListener('click', () => {
      state.shortRows = defaultShortRows();
      renderTables();
      updateSummary();
      setStatus('Ripristinato esempio short.');
    });

    function cleanRows(rows) {
      return rows
        .filter(row => row.strike != null || row.premium != null || row.realized != null)
        .map(row => ({
          strike: row.strike ?? 0,
          premium: row.premium ?? 0,
          contracts: row.qty ?? 0,
          active: ensureActive(row.active) === 1,
          realizedPL: row.realized ?? 0
        }));
    }

    function buildPayload() {
      const longActive = sumActiveLong();
      const shortActive = sumActiveShort();
      const realized = sumRealized();
      const plateau = longActive + shortActive + realized;

      return {
        generatedAt: new Date().toISOString(),
        multiplier: CONTRACT_MULTIPLIER,
        longPositions: cleanRows(state.longRows),
        shortPositions: cleanRows(state.shortRows),
        summary: {
          longActive,
          shortActive,
          realized,
          plateauMin: plateau
        }
      };
    }

    function setStatus(message, error = false) {
      statusLine.textContent = message;
      statusLine.classList.toggle('error', !!error);
      if (message) {
        setTimeout(() => {
          if (statusLine.textContent === message) {
            statusLine.textContent = '';
            statusLine.classList.remove('error');
          }
        }, 5000);
      }
    }

    document.getElementById('exportJson').addEventListener('click', () => {
      try {
        const payload = buildPayload();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = 'leap-risk-navigation-export.json';
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
        setStatus('JSON esportato con successo.');
      } catch (error) {
        console.error(error);
        setStatus('Errore durante l\'esportazione JSON.', true);
      }
    });

    document.getElementById('copyJson').addEventListener('click', async () => {
      try {
        const payload = JSON.stringify(buildPayload(), null, 2);
        await navigator.clipboard.writeText(payload);
        setStatus('JSON copiato negli appunti.');
      } catch (error) {
        console.error(error);
        setStatus('Impossibile copiare negli appunti (permessi?).', true);
      }
    });

    document.getElementById('importJson').addEventListener('change', event => {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(String(e.target?.result));
          applyImportedData(data);
          setStatus(`Import completato da "${file.name}".`);
        } catch (error) {
          console.error(error);
          setStatus('File JSON non valido.', true);
        }
      };
      reader.readAsText(file);
    });

    function applyImportedData(data) {
      if (data && typeof data === 'object') {
        if (Array.isArray(data.longPositions)) {
          state.longRows = data.longPositions.map(item => ({
            strike: parseNumber(item.strike),
            premium: parseNumber(item.premium),
            qty: parseNumber(item.contracts) ?? 1,
            active: item.active ? 1 : 0,
            realized: parseNumber(item.realizedPL)
          }));
        }

        if (Array.isArray(data.shortPositions)) {
          state.shortRows = data.shortPositions.map(item => ({
            strike: parseNumber(item.strike),
            premium: parseNumber(item.premium),
            qty: parseNumber(item.contracts) ?? 1,
            active: item.active ? 1 : 0,
            realized: parseNumber(item.realizedPL)
          }));
        }

        renderTables();
        updateSummary();
      }
    }

    async function preloadJson() {
      try {
        const response = await fetch('leap-risk-navigation.json');
        if (!response.ok) return;
        const data = await response.json();
        applyImportedData(data);
        setStatus('Dati caricati da leap-risk-navigation.json.');
      } catch (error) {
        console.warn('Impossibile precaricare il JSON locale.', error);
      }
    }

    renderTables();
    updateSummary();
    preloadJson();
  </script>
</body>
</html>
